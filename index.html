<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <meta name="description" content="">
        <meta name="author" content="">
        <link rel="icon" href="../../favicon.ico">
        
        <title>Weather App</title>
        
        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic,700,700italic' rel='stylesheet' type='text/css'>
        
        <!-- Custom styles for this template -->
        <link href="css/style.css" rel="stylesheet">
        <link href="css/weather-icons.min.css" rel="stylesheet">
        <link href="css/weather-icons-wind.min.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    
    <body>
    	<div class="wrapper">
            <div class="container">
                <div class="row">
                    <div class="col-sm-12">
                    <p id="city"></p>
                    <p id="weather"></p>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-sm-12 weather-details">
                        <span><i id="icon"></i></span>
                        <span id="temperature"></span>
                        <span class="degree">&deg;<a href="#" id="unit" onClick="changeUnit();return false">C</a></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12" id="date">
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12" id="day">
                    <span id="sunset">Sunset: </span>
                    <span id="sunrise">Sunrise: </span>
                    </div>
                 </div>
                 <div class="row">
                    <div class="col-sm-12" id="other_info">
                    <span id="humidity">Humidity: </span>
                    <span id="wind">Wind Speed: </span>
                    </div>
                 </div>
            </div><!-- .container -->
        </div>
        
        
        <!-- Bootstrap core JavaScript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <script src="json/icons.json"></script>
        <script>
        
        var currentWeather, city;
        function getData(url) {
          return new Promise(function(resolve, reject) {
            var req = new XMLHttpRequest();
            req.open('GET', url, true);
            req.onload = function() {
              if (req.status == 200) {
                resolve(req.response);
              }
              else {
                reject(Error(req.statusText));
              }
            };
        
            req.onerror = function() {
              reject(Error("Network Error"));
            };
        
            req.send();
          });
        }
        
        /*
        {"coord":{"lon":-122.83,"lat":49.11},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"base":"stations","main":{"temp":292.75,"pressure":1015,"humidity":72,"temp_min":289.82,"temp_max":297.04},"wind":{"speed":1.03,"deg":245,"gust":3.08},"rain":{"3h":0.2975},"clouds":{"all":92},"dt":1466646729,"sys":{"type":3,"id":9197,"message":0.0293,"country":"CA","sunrise":1466683632,"sunset":1466742010},"id":6159905,"name":"Surrey","cod":200}
        */
        
            
        function init() {
            getLocation()
            .then(function(response) {
                setLocation(response);
                getWeatherData().then(function(response){
                setWeather(response);
                getIcon(response);
				setCurrentTime(response);
				setOtherInfo(response);
                })
                .catch(function(error) { 
                    document.write('Error1: ', error);
                });
            })
            .catch(function(error) { 
                document.write('Error2: ', error);
            });
        }
        
        function getLocation() {
            locationApiurl = "http://ipinfo.io/json";
            return getData(locationApiurl);
        }			
            
        function setLocation(locationData) {
            loc = JSON.parse(locationData);
            city = loc.city+","+loc.country;	
        }
        
        function getWeatherData() {
            var weatherApiUrl = "http://api.openweathermap.org/data/2.5/weather?q=";
            var weatherAppId = "&APPID=7040a1f543f50652aee32c6eeedc83e7";
            var units = "&units=metric";
            return getData(weatherApiUrl+city+weatherAppId+units)
        }
        
        function setWeather(weatherObject) {
            var rawData = JSON.parse(weatherObject);
			console.log(rawData);
            var weather = [];
            for(i=0; i< rawData.weather.length; i++) {
                weather[i] = rawData.weather[i].description;
            }
            currentWeather = {
            "city": rawData.name,
            "country":rawData.sys.country,
            "weather": weather,
            "temperature": Math.ceil(rawData.main.temp)}
            document.getElementById('city').innerHTML = rawData.name +", "+rawData.sys.country;
            document.getElementById('temperature').innerHTML = currentWeather["temperature"];
            document.getElementById('weather').innerHTML = weather.toString();
        }
        
        function getIcon(resp) {
            var weatherIcons =  data  ;
            var prefix = 'wi wi-';
            var code = JSON.parse(resp).weather[0].id;
            var icon = weatherIcons[code].icon;
        
              // If we are not in the ranges mentioned above, add a day/night prefix.
              if (!(code > 699 && code < 800) && !(code > 899 && code < 1000)) {
                icon = 'night-' + icon;
              }
            
              // Finally tack on the prefix.
                icon = prefix + icon;
              document.getElementById('icon').className =  icon;
        }
        
        function changeUnit(){
            var currentUnit = document.getElementById( 'unit' ).innerHTML;
            if(currentUnit == "C") {
             document.getElementById( 'unit' ).innerHTML = "F";
             document.getElementById('temperature').innerHTML =  cToF(currentWeather["temperature"]);
            } else {
                 document.getElementById( 'unit' ).innerHTML = "C";
                 document.getElementById('temperature').innerHTML =  currentWeather["temperature"];
            }
        }
        
        
        function cToF(celsius)   
        {  
          return  Math.ceil(celsius * 9 / 5 + 32);  
        }
		
		function setCurrentTime(weatherObj) {
			var weatherData = JSON.parse(weatherObj);
			time = unixToTime(weatherData.dt);
			document.getElementById('date').innerHTML = time;
		}
		
		function setOtherInfo(weatherObj) {
			var weatherData = JSON.parse(weatherObj);
			document.getElementById('sunset').innerHTML += unixToTime(weatherData.sys.sunset, "time");
			document.getElementById('sunrise').innerHTML += unixToTime(weatherData.sys.sunrise, "time");
			document.getElementById('humidity').innerHTML += weatherData.main.humidity+"%";
			document.getElementById('wind').innerHTML += weatherData.wind.speed+"mps";
		}		
		
		function unixToTime(timestamp, returnType){
		  var a = new Date(timestamp * 1000);
		  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		  var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
		  var year = a.getFullYear();
		  var month = months[a.getMonth()];
		  var date = a.getDate();
		  var day = days[a.getDay()];
		  var hour = a.getHours();
		  var mins = a.getMinutes()< 10 ? '0' + a.getMinutes() : a.getMinutes();
		  //var sec = a.getSeconds() < 10 ? '0' + a.getSeconds() : a.getSeconds();
		  var CurrentDate = day + ", " + date + ' ' + month + ' ' + year;
		  var time = hour + ':' + mins;
		  var dateTime = CurrentDate + ' ' + time ;
		  switch(returnType) {
		  	case "time":
				return time;
			case "date":
				return CurrentDate;
			default:
				return dateTime;
		  }
		  
		}
        
        
        init();
        </script>
    </body>
</html>
